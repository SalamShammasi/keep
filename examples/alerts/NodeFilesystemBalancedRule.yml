
# Alert description: this alert will trigger if the filesystem in node is not balanced

# Alert breakdown:
# 1. Read all nodes ids from postgres (select id from filesystem)
# 2. For each node, gets all filesystem (select * from filesystem where id = {{ node_id }})
# 3. For each filesystem, check if the filesystem is balanced (stddev = 1)
# 4. If the filesystem is not balanced, insert a new row to the alert table with the node id and the filesystem name.
alert:
  id: NodeFilesystemBalancedRule
  steps:
    # Get all nodes ids
    - name: get-node-ids
      provider:
        type: postgres
        config: "{{ providers.postgres-server }}"
        with:
          query: "select distinct(node_id) from filesystem;"
    # For each node id, get the filesystem status and find filesystems in node that are not balanced
    - name: get-filesystems-by-node-id
      foreach: "{{ steps.get-node-ids.results }}"
      provider:
        type: postgres
        config: "{{ providers.postgres-server }}"
        with:
          query: "select * from filesystem where node_id = '{{ foreach.value[0] }}';"
  actions:
    - name: push-alert-to-postgres
      # Run on get-filesystems-by-node-id results.
      # Notice each result is a list of filesystems in node
      foreach: "{{ steps.get-filesystems-by-node-id.results }}"
      # Alert on nodes that have filesystems that away from the standard deviation
      condition:
        - name: stddev-condition
          type: stddev
          value:  "{{ foreach.value }}"
          pivot_column: 8 # 8th column is the filesystem usage percentage
          compare_to: 1

      provider:
        type: postgres
        config: "{{ providers.postgres-server }}"
        with:
          query: >
            INSERT INTO alert (alert_level, alert_message)
            VALUES ('major', 'The node {{ foreach.value[0][4] }} has filesystems that are not balanced:
                    {{#foreach.stddev}}
                    - Filesystem {{ value[0] }} is {{stddev}} away from the standard deviation
                    {{/foreach.stddev}}')

providers:
  postgres-server:
    description: The postgres server (sql)
    authentication:
      username: "{{ env.POSTGRES_USER }}"
      password: "{{ env.POSTGRES_PASSWORD }}"
      database: "{{ env.POSTGRES_DATABASE }}"
      host:  "{{ env.POSTGRES_HOST }}"
