# Database disk space is low (<10%)
alert:
  id: db-disk-space
  description: Check that the DB has enough disk space
  owners:
    - github-shahargl
    - slack-talboren
  services:
    - db
    - api
  trigger:
    # Run every hour or if the service-is-failing alert is triggered
    interval: 1h
    event:
      - id: service-is-failing
        type: alert
  steps:
    - name: db-no-space
      provider:
          type: mock
          config: "{{ providers.db-server-mock }}"
          with:
            command: df -h | grep /dev/disk3s1s1 | awk '{ print $5}'  # Check the disk space
            command_output: 91% # Mock
      condition:
        - type: threshold
          value: 90% # Trigger if more than 90% full
          compare_to: "{{ steps.this.results }}"
      failure_strategy: # What to do if the SSH connection failed?
        - name: ssh-connection-failed
          retry: 5 # Retry 5 times
          alert: true # Finally, alert
  actions:
    - name: trigger-slack
      provider:
        type: slack
        config: " {{ providers.paladin-slack }} "
        with:
          channel: db-is-down
          # Message is always mandatory
          message: >
            The disk space of {{ providers.db-server-mock.id }} [{{ providers.db-server-mock.description }}] is about to finish
            Disk space left: {{ steps.db-no-space.output }}
          blocks:
            - type: section
              block_id: "section567"
              text:
                type: "mrkdwn"
                text: "Space left on device: {{ steps.db-no-space.output }}"
              accessory:
                type: image
                image_url: "https://datavizproject.com/wp-content/uploads/types/Line-Graph.png"
                alt_text: "Graph"

provider:
- id: db-server-mock
  description: mocks a db server
  authentication:
- id: paladin-slack
  description: Paladin's slack
  authentication:
    webhook-url: https://hooks.slack.com/services/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
