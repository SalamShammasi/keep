# Alert if the schemas versions of my customers are not the same
#   (each schema version stored in ALEMBIC_VERSION table in the customer db)
alert:
  id: raw-sql-query
  description: Monitor that time difference is no more than 1 hour
  steps:
    - name: get-max-datetime
      provider:
        type: mysql
        config: "{{ providers.mysql-prod }}"
        with:
          # Get max(datetime) from the random table
          query: "SELECT MAX(datetime) FROM demo_table LIMIT 1"
      condition:
      - type: threshold
        value: datetime_compare(utcnow(), to_utc({{ steps.this.results[0][0] }}))
        compare_to: 1 # hours
        compare_type: gt # greater than
  actions:
    - name: trigger-slack
      provider:
        type: slack
        config: " {{ providers.slack-demo }} "
        with:
          # Message is always mandatory
          message: "DB datetime value ({{ steps.get-max-datetime.conditions.threshold.0.value }}) is greater than 1! ðŸš¨"
